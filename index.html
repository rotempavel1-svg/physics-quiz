<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physix Pro - Zoom Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --accent: #60a5fa; 
            --success: #4ade80;
            --error: #f87171;
            --glass-border: 1px solid rgba(255, 255, 255, 0.15);
            --bg-base: #1e293b;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; font-family: 'Heebo', sans-serif; }

        body {
            margin: 0; padding: 0; width: 100vw; height: 100dvh; overflow: hidden;
            color: #f1f5f9;
            background-color: var(--bg-base);
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- ××¡×š ×¤×ª×™×—×” --- */
        #topic-screen {
            position: fixed; inset: 0; z-index: 200; 
            background: var(--bg-base);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .grid-topics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px; width: 90%; max-width: 700px; max-height: 65vh; overflow-y: auto; padding: 10px;
        }
        .btn-topic {
            background: rgba(255,255,255,0.05); border: var(--glass-border);
            padding: 20px; border-radius: 12px; color: white; cursor: pointer; 
            text-align: center; font-weight: bold; transition: 0.2s;
        }
        .btn-topic:hover { background: var(--accent); color: white; }

        /* --- ×××©×§ ××©×—×§ --- */
        #game-ui {
            display: none; width: 100%; height: 100%;
            display: grid;
            grid-template-columns: 90px 1fr 90px; 
            grid-template-rows: 50px 1fr 60px;
            grid-template-areas: 
                "head head head"
                "right img left"
                "right img left"
                "ctrl ctrl ctrl";
        }

        header {
            grid-area: head; display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            background: rgba(0,0,0,0.2); border-bottom: var(--glass-border); z-index: 50;
        }

        /* --- ××–×•×¨ ×”×ª××•× ×” ×•×”×–×•× --- */
        .stage {
            grid-area: img; position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; padding: 5px; cursor: zoom-in; /* ×¡××Ÿ ×–×•× */
        }
        
        .img-wrapper {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
        }

        .q-img {
            /* ×”×”×’×“×¨×” ×”×–×• ××‘×˜×™×—×” ×©×”×ª××•× ×” ×ª××™×“ ×ª×ª×¤×•×¡ ××§×¡×™××•× ××§×•× */
            width: 100%; height: 100%; 
            object-fit: contain; 
            z-index: 1; filter: drop-shadow(0 0 20px rgba(0,0,0,0.3));
        }

        /* ××™×™×§×•×Ÿ ×–×•× ×¢×œ ×”×ª××•× ×” */
        .zoom-hint {
            position: absolute; bottom: 10px; right: 10px;
            background: rgba(0,0,0,0.6); color: white;
            padding: 8px; border-radius: 50%; pointer-events: none;
            z-index: 5; font-size: 1.2rem;
        }

        /* Lightbox (××¡×š ××œ×) */
        #lightbox {
            display: none; position: fixed; inset: 0; z-index: 999;
            background: rgba(0,0,0,0.95);
            justify-content: center; align-items: center;
            cursor: zoom-out;
        }
        #lightbox img {
            max-width: 95vw; max-height: 95vh;
            object-fit: contain;
            box-shadow: 0 0 50px rgba(255,255,255,0.1);
        }

        /* Canvas */
        #canvas-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; cursor: crosshair; display: none;
        }

        /* ×›×¤×ª×•×¨×™ ×¦×“ */
        .side-col {
            display: flex; flex-direction: column; justify-content: center; gap: 10px; padding: 5px; z-index: 20;
        }
        #col-right { grid-area: right; }
        #col-left  { grid-area: left; }

        .btn-ans {
            width: 100%; aspect-ratio: 1/1; max-height: 80px;
            border-radius: 12px; border: var(--glass-border);
            background: rgba(255,255,255,0.05); color: white;
            font-size: 1.5rem; font-weight: 800; cursor: pointer;
            display: flex; justify-content: center; align-items: center;
        }
        .btn-ans:hover { border-color: var(--accent); background: rgba(96, 165, 250, 0.15); }
        .btn-ans.correct { background: var(--success); color: black; border-color: var(--success); box-shadow: 0 0 20px var(--success); }
        .btn-ans.wrong { background: var(--error); opacity: 0.3; border-color: var(--error); }

        /* ×©×œ×™×˜×” ×œ××˜×” */
        .controls-bar {
            grid-area: ctrl; display: flex; justify-content: center; align-items: center; gap: 15px;
            background: rgba(0,0,0,0.3); border-top: var(--glass-border); z-index: 50;
        }
        .btn-action {
            padding: 10px 40px; border-radius: 30px; border: 1px solid rgba(255,255,255,0.2);
            background: transparent; color: white; font-weight: bold; cursor: pointer;
        }
        #reveal-btn:hover { background: var(--accent); }
        #next-btn { background: var(--success); color: black; display: none; border:none; }

        /* ×›×œ×™× ×¦×¤×™× */
        .floating-tools {
            position: absolute; top: 10px; left: 10px; z-index: 60;
            display: flex; flex-direction: column; gap: 8px;
        }
        .tool-icon {
            width: 38px; height: 38px; border-radius: 50%; 
            background: rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.2); color: white;
            display: flex; justify-content: center; align-items: center; cursor: pointer;
        }
        .tool-icon.active { background: var(--accent); color: white; }

        /* Zen Mode */
        body.zen-mode #game-ui > *:not(.stage) { opacity: 0; pointer-events: none; }
        body.zen-mode .floating-tools button:not(#zen-toggle) { display: none; }
        body.zen-mode { background-image: none; background-color: #000; }

        /* Mobile */
        @media (max-width: 768px) {
            #game-ui { display: flex; flex-direction: column; }
            .stage { flex-grow: 1; min-height: 0; padding: 5px; }
            .side-col { display: none; }
            
            #mobile-grid {
                display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; padding: 8px;
                background: rgba(0,0,0,0.2); z-index: 60;
            }
            #mobile-grid .btn-ans { aspect-ratio: auto; height: 50px; border-radius: 8px; font-size: 1.2rem; }
            
            .controls-bar { height: 50px; padding: 5px; }
            .floating-tools { top: 5px; left: 5px; flex-direction: row; }
        }
        
        #mobile-grid { display: none; }
        @media (max-width: 768px) { #mobile-grid { display: grid; } }

    </style>
</head>
<body>

    <div id="topic-screen">
        <h1 style="font-size: 3rem; margin-bottom: 20px; color: var(--accent);">Physix Pro</h1>
        <div class="grid-topics" id="topics-box"></div>
        <button class="btn-topic" onclick="start('mix')" style="width:250px; margin-top:30px; border-color: var(--accent);">ğŸ² ×ª×¨×’×•×œ ××¡×›×</button>
    </div>

    <div id="game-ui">
        <header>
            <i class="fas fa-home" onclick="location.reload()" style="font-size:1.5rem; cursor:pointer; opacity:0.8;"></i>
            <div id="topic-title" style="color: var(--accent); font-weight: bold;"></div>
            <div id="timer" style="font-family: monospace; font-size: 1.2rem; font-weight: bold;">00:00</div>
        </header>

        <div class="stage" id="stage-box">
            <div class="img-wrapper" onclick="openLightbox()">
                <img id="q-img" class="q-img" src="">
                <div class="zoom-hint"><i class="fas fa-search-plus"></i></div>
            </div>
            
            <canvas id="canvas-layer"></canvas>
            
            <div class="floating-tools">
                <button class="tool-icon" id="zen-toggle" onclick="toggleZen()"><i class="fas fa-eye-slash"></i></button>
                <button class="tool-icon" id="draw-toggle" onclick="toggleDraw()"><i class="fas fa-pen"></i></button>
                <button class="tool-icon" onclick="clearCanvas()"><i class="fas fa-eraser"></i></button>
            </div>
        </div>

        <div class="side-col" id="col-right"></div>
        <div class="side-col" id="col-left"></div>
        <div id="mobile-grid"></div>

        <div class="controls-bar">
            <button class="btn-action" id="reveal-btn" onclick="reveal()">ğŸ’¡ ×’×œ×” ×ª×©×•×‘×”</button>
            <button class="btn-action" id="next-btn" onclick="nextQ()">×”×‘× âœ</button>
        </div>
    </div>

    <div id="lightbox" onclick="closeLightbox()">
        <img id="lightbox-img" src="">
    </div>

    <script src="questions.js"></script>
    <script>
        let queue = [], curr = null, solved = false, tInt, sec = 0;
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        window.onload = function() {
            if(typeof questions === 'undefined') return alert("×—×¡×¨ ×§×•×‘×¥ ×©××œ×•×ª!");
            const box = document.getElementById('topics-box');
            [...new Set(questions.map(q=>q.topic))].forEach(t => {
                let b = document.createElement('div');
                b.className = 'btn-topic'; b.innerText = t; b.onclick = () => start(t);
                box.appendChild(b);
            });
            setupCanvas();
        };

        function start(topic) {
            queue = topic === 'mix' ? [...questions] : questions.filter(q => q.topic === topic);
            if(!queue.length) return;
            queue.sort(() => Math.random() - 0.5);
            queue = queue.map(q => ({...q, mistakes:0}));
            document.getElementById('topic-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = (window.innerWidth > 768) ? 'grid' : 'flex';
            document.getElementById('topic-title').innerText = topic;
            loadQ();
        }

        function loadQ() {
            if(!queue.length) { alert("×¡×™×™××ª!"); return location.reload(); }
            curr = queue[0]; solved = false; sec = 0;
            clearInterval(tInt);
            tInt = setInterval(() => {
                sec++;
                document.getElementById('timer').innerText = 
                    `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
            }, 1000);

            // ×¢×“×›×•×Ÿ ×ª××•× ×” ×¨×’×™×œ×” + ×ª××•× ×ª ×–×•×
            document.getElementById('q-img').src = curr.image;
            document.getElementById('lightbox-img').src = curr.image;
            
            document.getElementById('reveal-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
            renderButtons();
            clearCanvas();
        }

        function renderButtons() {
            const right = document.getElementById('col-right');
            const left = document.getElementById('col-left');
            const mobile = document.getElementById('mobile-grid');
            [right, left, mobile].forEach(el => el.innerHTML = '');

            const split = Math.ceil(curr.options.length / 2);

            curr.options.forEach((opt, i) => {
                let btn = document.createElement('button');
                btn.className = 'btn-ans';
                btn.innerText = i + 1;
                btn.onclick = () => check(i);
                
                if(i < split) right.appendChild(btn.cloneNode(true));
                else left.appendChild(btn.cloneNode(true));
                mobile.appendChild(btn.cloneNode(true));
            });
            
            document.querySelectorAll('.btn-ans').forEach(b => {
                b.onclick = () => check(parseInt(b.innerText) - 1);
            });
        }

        function check(idx) {
            if(solved) return;
            const btns = Array.from(document.querySelectorAll('.btn-ans')).filter(b => parseInt(b.innerText) === idx + 1);
            if(idx === curr.answer) {
                btns.forEach(b => b.classList.add('correct'));
                confetti({ origin: { y: 0.8 }, colors: ['#60a5fa', '#ffffff'] });
                onSolved(true);
            } else {
                btns.forEach(b => b.classList.add('wrong'));
                curr.mistakes++;
            }
        }

        function reveal() {
            if(solved) return;
            const btns = Array.from(document.querySelectorAll('.btn-ans')).filter(b => parseInt(b.innerText) === curr.answer + 1);
            btns.forEach(b => { b.classList.add('correct'); b.style.opacity = '0.7'; });
            onSolved(false);
        }

        function onSolved(success) {
            solved = true; clearInterval(tInt);
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
            if(success && curr.mistakes === 0) queue.shift();
            else { let q = queue.shift(); q.mistakes = 0; queue.push(q); }
        }

        function nextQ() { loadQ(); }
        function toggleZen() { 
            document.body.classList.toggle('zen-mode'); 
            document.getElementById('zen-toggle').classList.toggle('active');
        }

        // --- Lightbox Functions ---
        function openLightbox() {
            // ×× ××¦×‘ ×¦×™×•×¨ ×¤×¢×™×œ - ×œ× ×œ×¤×ª×•×— ×–×•× ×›×“×™ ×œ× ×œ×”×¤×¨×™×¢ ×œ×¦×™×•×¨
            if(document.getElementById('canvas-layer').style.display === 'block') return;
            document.getElementById('lightbox').style.display = 'flex';
        }
        function closeLightbox() {
            document.getElementById('lightbox').style.display = 'none';
        }

        // --- Canvas ---
        function setupCanvas() {
            const resize = () => {
                const s = document.getElementById('stage-box');
                canvas.width = s.clientWidth; canvas.height = s.clientHeight;
            };
            window.addEventListener('resize', resize);
            resize();
            ctx.lineWidth = 3; ctx.strokeStyle = "#f43f5e";
            
            const startDraw = (e) => {
                if(!isDrawing) return;
                const r = canvas.getBoundingClientRect();
                ctx.beginPath();
                ctx.moveTo((e.clientX||e.touches[0].clientX) - r.left, (e.clientY||e.touches[0].clientY) - r.top);
            };
            const draw = (e) => {
                if(!isDrawing) return;
                const r = canvas.getBoundingClientRect();
                ctx.lineTo((e.clientX||e.touches[0].clientX) - r.left, (e.clientY||e.touches[0].clientY) - r.top);
                ctx.stroke();
            };
            canvas.addEventListener('mousedown', (e)=>{ isDrawing=true; startDraw(e); });
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', ()=>{ isDrawing=false; ctx.beginPath(); });
            canvas.addEventListener('touchstart', (e)=>{ if(canvas.style.display==='block'){ e.preventDefault(); isDrawing=true; startDraw(e); }}, {passive:false});
            canvas.addEventListener('touchmove', (e)=>{ if(canvas.style.display==='block'){ e.preventDefault(); draw(e); }}, {passive:false});
            canvas.addEventListener('touchend', ()=>{ isDrawing=false; });
        }

        function toggleDraw() {
            const c = document.getElementById('canvas-layer');
            const b = document.getElementById('draw-toggle');
            if(c.style.display === 'block') { c.style.display = 'none'; b.classList.remove('active'); }
            else { c.style.display = 'block'; b.classList.add('active'); 
                   canvas.width = document.getElementById('stage-box').clientWidth; 
                   canvas.height = document.getElementById('stage-box').clientHeight; }
        }
        function clearCanvas() { ctx.clearRect(0,0,canvas.width, canvas.height); }
    </script>
</body>
</html>