<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physix Pro - Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --panel: rgba(30, 41, 59, 0.95);
            --accent: #38bdf8;
            --success: #4ade80;
            --error: #f87171;
            --text: #f8fafc;
            --orange: #fb923c;
        }

        * { box-sizing: border-box; user-select: none; font-family: 'Heebo', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0; height: 100vh; width: 100vw; overflow: hidden;
            background: #0f172a; color: var(--text);
            display: flex; flex-direction: column;
        }

        /* --- 住 驻转 --- */
        #topic-screen {
            position: fixed; inset: 0; z-index: 100; background: var(--bg-dark);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .grid-topics {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px; width: 90%; max-width: 800px; max-height: 60vh; overflow-y: auto;
        }
        .btn-topic {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            padding: 20px; border-radius: 15px; color: white; font-size: 1.2rem; cursor: pointer;
            text-align: center; transition: 0.2s;
        }
        .btn-topic:hover { background: var(--accent); color: black; transform: translateY(-3px); }

        /* --- 砖拽 砖拽 --- */
        #game-ui { display: none; height: 100%; flex-direction: column; }

        /* HEADER - 住  驻转 拽 转 */
        header {
            height: 50px; background: var(--panel); border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: space-between; align-items: center; padding: 0 20px;
            flex-shrink: 0; z-index: 10;
        }

        /* MAIN STAGE - 转   */
        .stage {
            flex-grow: 1; display: flex; position: relative; overflow: hidden;
            background: #000; /* 专拽注 砖专 转 */
        }

        .img-wrapper {
            flex: 1; position: relative; display: flex; justify-content: center; align-items: center;
            padding: 10px;
        }

        /* 转 转驻住转 拽住 拽 */
        .q-img {
            max-width: 100%; max-height: 100%; 
            object-fit: contain; /*  转转  */
            z-index: 1;
        }

        /* CANVAS -  爪专 */
        #canvas-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 5; cursor: crosshair; display: none;
        }

        /* 住专  爪祝 */
        .toolbar {
            position: absolute; top: 20px; left: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 50;
        }
        .tool-btn {
            width: 45px; height: 45px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.1); color: white; font-size: 1.2rem;
            cursor: pointer; backdrop-filter: blur(5px); transition: 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .tool-btn:hover { background: var(--accent); color: black; }
        .tool-btn.active { background: var(--accent); color: black; box-shadow: 0 0 15px var(--accent); }

        /* 驻转专 "注" - 驻  */
        #zen-btn { z-index: 9999; } 
        #zen-btn.zen-active { background: var(--orange); color: white; box-shadow: 0 0 20px var(--orange); }

        /* FOOTER - 转砖转 */
        footer {
            min-height: 120px; background: var(--panel); border-top: 1px solid rgba(255,255,255,0.1);
            padding: 15px; display: flex; flex-direction: column; gap: 10px; align-items: center;
            flex-shrink: 0; z-index: 10; transition: opacity 0.3s;
        }

        .ans-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; width: 100%; max-width: 800px;
        }
        .btn-ans {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.2);
            color: white; height: 60px; border-radius: 10px; font-size: 1.5rem; font-weight: bold;
            cursor: pointer; transition: 0.2s;
        }
        .btn-ans:hover { background: rgba(255,255,255,0.15); border-color: white; }
        .btn-ans.correct { background: var(--success); color: black; border-color: var(--success); }
        .btn-ans.wrong { background: var(--error); opacity: 0.3; }

        .controls { display: flex; gap: 10px; width: 100%; max-width: 400px; }
        .btn-ctrl {
            flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: bold; font-size: 1.1rem; cursor: pointer;
        }
        #reveal-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        #reveal-btn:hover { background: var(--accent); color: black; }
        
        #next-btn { background: var(--success); color: black; display: none; }

        /* 爪  - 砖  抓 转 驻转专 注 */
        body.zen-mode header, 
        body.zen-mode footer, 
        body.zen-mode .mascot,
        body.zen-mode .toolbar button:not(#zen-btn) {
            opacity: 0.05; pointer-events: none;
        }
        body.zen-mode .stage { background: #000; }

        /* 转 */
        .mascot {
            position: absolute; bottom: 140px; left: 20px; width: 100px; pointer-events: none;
            filter: drop-shadow(0 5px 10px black); transition: 0.3s; z-index: 20;
        }
        
        /*  */
        @media (max-width: 768px) {
            .ans-grid { grid-template-columns: 1fr 1fr; }
            .mascot { width: 70px; bottom: 180px; opacity: 0.7; }
            .toolbar { top: 10px; left: 10px; }
        }
    </style>
</head>
<body>

    <div id="topic-screen">
        <h1 style="font-size: 3rem; margin-bottom: 20px; color: var(--accent);">Physix Pro</h1>
        <div class="grid-topics" id="topics-box"></div>
        <button class="btn-topic" onclick="start('mix')" style="margin-top:20px; width:200px; background:linear-gradient(45deg, #6366f1, #a855f7); border:none;"> 拽住 住</button>
    </div>

    <div id="game-ui">
        <header>
            <button onclick="goHome()" style="background:none; border:none; color:white; font-size:1.2rem; cursor:pointer;"><i class="fas fa-home"></i></button>
            <div id="topic-lbl" style="font-weight:bold; color:var(--accent);"></div>
            <div style="font-family:monospace; font-size:1.2rem;" id="timer">00:00</div>
        </header>

        <div class="stage">
            <div class="toolbar">
                <button class="tool-btn" id="zen-btn" onclick="toggleZen()"><i class="fas fa-eye-slash"></i></button>
                <button class="tool-btn" id="draw-btn" onclick="toggleDraw()"><i class="fas fa-pen"></i></button>
                <button class="tool-btn" onclick="clearCanvas()"><i class="fas fa-eraser"></i></button>
            </div>

            <div class="img-wrapper" id="img-area">
                <img id="q-image" class="q-img" src="" alt="砖">
                <canvas id="canvas-layer"></canvas>
            </div>
            
            <img src="images/mascot/mascot_idle.png" class="mascot" id="mascot">
        </div>

        <footer>
            <div class="ans-grid" id="ans-btns">
                </div>
            <div class="controls">
                <button id="reveal-btn" class="btn-ctrl" onclick="revealAnswer()">  转砖 / </button>
                <button id="next-btn" class="btn-ctrl" onclick="nextQ()"> <i class="fas fa-arrow-left"></i></button>
            </div>
        </footer>
    </div>

    <script src="questions.js"></script>
    <script>
        let queue = [];
        let curr = null;
        let solved = false;
        let timerInt;
        let seconds = 0;

        // Canvas setup
        const canvas = document.getElementById('canvas-layer');
        const ctx = canvas.getContext('2d');
        let isDrawing = false;

        window.onload = function() {
            if(typeof questions === 'undefined') return alert("住专 拽抓 砖转");
            
            const box = document.getElementById('topics-box');
            [...new Set(questions.map(q=>q.topic))].forEach(t => {
                let b = document.createElement('div');
                b.className = 'btn-topic';
                b.innerText = t;
                b.onclick = () => start(t);
                box.appendChild(b);
            });
            
            setupCanvas();
        };

        function start(topic) {
            queue = (topic === 'mix' ? [...questions] : questions.filter(q => q.topic === topic));
            if(!queue.length) return;
            queue.sort(() => Math.random() - 0.5);
            queue = queue.map(q => ({...q, mistakes:0}));
            
            document.getElementById('topic-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'flex';
            document.getElementById('topic-lbl').innerText = topic;
            
            loadQ();
        }

        function loadQ() {
            if(!queue.length) { alert("住转!"); return goHome(); }
            
            curr = queue[0];
            solved = false;
            seconds = 0;
            clearInterval(timerInt);
            timerInt = setInterval(() => {
                seconds++;
                let m = Math.floor(seconds/60).toString().padStart(2,'0');
                let s = (seconds%60).toString().padStart(2,'0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            }, 1000);

            // 驻住 砖拽
            document.getElementById('q-image').src = curr.image;
            document.getElementById('mascot').src = "images/mascot/mascot_idle.png";
            document.getElementById('reveal-btn').style.display = 'block';
            document.getElementById('next-btn').style.display = 'none';
            
            // 驻住 驻转专
            const grid = document.getElementById('ans-btns');
            grid.innerHTML = '';
            curr.options.forEach((opt, i) => {
                let btn = document.createElement('button');
                btn.className = 'btn-ans';
                btn.innerText = i + 1;
                btn.onclick = () => check(btn, i);
                grid.appendChild(btn);
            });

            clearCanvas();
        }

        function check(btn, idx) {
            if(solved) return;
            
            if(idx === curr.answer) {
                // 转砖 
                btn.classList.add('correct');
                confetti({ particleCount: 100, spread: 70, origin: { y: 0.8 } });
                document.getElementById('mascot').src = "images/mascot/mascot_happy.png";
                onSolved(true);
            } else {
                // 注转
                btn.classList.add('wrong');
                curr.mistakes++;
                document.getElementById('mascot').src = "images/mascot/mascot_sad.png";
            }
        }

        function revealAnswer() {
            if(solved) return;
            
            // 爪 转 驻转专  住 转
            const buttons = document.querySelectorAll('.btn-ans');
            buttons[curr.answer].classList.add('correct');
            
            // 住  砖 ""  驻转专
            buttons[curr.answer].style.opacity = "0.7"; 
            
            onSolved(false); // false =  驻转专 注爪转
        }

        function onSolved(success) {
            solved = true;
            clearInterval(timerInt);
            
            // 驻转 驻转专  驻转专 
            document.getElementById('reveal-btn').style.display = 'none';
            document.getElementById('next-btn').style.display = 'block';
            
            //  转专 砖转
            if(success && curr.mistakes === 0) {
                queue.shift(); // 住专 转专
            } else {
                let q = queue.shift();
                q.mistakes = 0; // 驻住 注转 驻注 
                queue.push(q); // 专 住祝 转专
            }
        }

        function nextQ() { loadQ(); }

        function goHome() {
            location.reload();
        }

        // --- Zen Mode Fix ---
        function toggleZen() {
            document.body.classList.toggle('zen-mode');
            document.getElementById('zen-btn').classList.toggle('zen-active');
        }

        // --- Canvas Logic ---
        function setupCanvas() {
            function resize() {
                canvas.width = document.getElementById('img-area').clientWidth;
                canvas.height = document.getElementById('img-area').clientHeight;
            }
            window.addEventListener('resize', resize);
            resize(); // Init size

            ctx.lineWidth = 3;
            ctx.strokeStyle = "#e11d48"; //  注
            
            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', endDraw);
            canvas.addEventListener('touchstart', (e)=>{e.preventDefault(); startDraw(e.touches[0])});
            canvas.addEventListener('touchmove', (e)=>{e.preventDefault(); draw(e.touches[0])});
            canvas.addEventListener('touchend', endDraw);
        }

        function toggleDraw() {
            const c = document.getElementById('canvas-layer');
            const btn = document.getElementById('draw-btn');
            if(c.style.display === 'block') {
                c.style.display = 'none';
                btn.classList.remove('active');
            } else {
                c.style.display = 'block';
                btn.classList.add('active');
                // 住专  砖驻转
                canvas.width = document.getElementById('img-area').clientWidth;
                canvas.height = document.getElementById('img-area').clientHeight;
            }
        }

        function startDraw(e) {
            isDrawing = true;
            const rect = canvas.getBoundingClientRect();
            ctx.beginPath();
            ctx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
        }
        function draw(e) {
            if(!isDrawing) return;
            const rect = canvas.getBoundingClientRect();
            ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
            ctx.stroke();
        }
        function endDraw() { isDrawing = false; }
        function clearCanvas() { ctx.clearRect(0,0,canvas.width, canvas.height); }

    </script>
</body>
</html>